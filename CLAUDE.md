# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリでコードを扱う際のガイダンスを提供します。

## プロジェクト概要

これはVue.js 3で構築されたWebベースのリアルタイムピッチ検出・チューナーアプリケーションです。ユーザーのマイクから音声を取得し、検出されたピッチを視覚的な五線譜とチューニングフィードバックで表示します。

## アーキテクチャ

### コア要素
- **index.html**: 埋め込みCSSとVue.jsセットアップを含むシングルページアプリケーション
- **script.js**: ピッチ検出ロジックを含むメインVue.jsアプリケーション
- **lib/pitchy.mjs**: 自己相関とNSDFアルゴリズムを使用するバンドル化されたピッチ検出ライブラリ（Pitchy）
- **lib/fft.mjs**: 音声処理用FFT（高速フーリエ変換）ライブラリ
- **lib/vue.global.js**: Vue.js 3ランタイム

### 主要機能
- リアルタイム音声取得とピッチ検出
- 音名とスケール音を表示する視覚的五線譜
- セント偏差表示付きチューニングインジケータ
- 複数の音名システム（CDEFGAB、ドレミファソラシ、など）
- スケール選択（長調/短調）
- 音声波形のオシロスコープビュー
- 設定可能なA4周波数基準

## 音声処理パイプライン

1. **音声入力**: Web Audio APIでマイク音声を取得
2. **信号処理**: 
   - ダイナミック圧縮（閾値: -60dB、比率: 20:1）
   - ゲイン増幅（20倍）
   - FFT解析（4096サンプル、4部分）
3. **ピッチ検出**: 自己相関とNSDFを使用するPitchyライブラリ
4. **視覚出力**: ピッチトラッキング付きリアルタイムcanvasレンダリング

## 開発コマンド

これはビルドプロセスのないクライアントサイドのみのアプリケーションです。開発時は：

```bash
# アプリケーションをローカルでサーブ（任意のHTTPサーバー）
python -m http.server 8000
# または
npx serve .
```

## ファイル構造の注意点

- package.jsonビルドスクリプトなし - これは静的Webアプリケーション
- ライブラリはesm.shからの事前バンドル化ESモジュール
- すべてのスタイリングはindex.htmlに埋め込み
- デバイスピクセル比対応のcanvasベース可視化
- Vue.js 3 Composition APIは未使用 - Options APIパターンを使用

## 主要技術詳細

- **ピッチ検出**: 4096 FFTから各1024サンプルの4部分解析
- **音程計算**: A4=440Hz基準、12平均律
- **Canvasレンダリング**: デバイスピクセル比対応、リアルタイムグラフ更新
- **AudioContext**: 44.1kHzサンプリングレート、インタラクティブ遅延ヒント
- **スケールロジック**: 設定可能なキーでの長調/短調スケール音ハイライト

## 開発方針

### テストと品質への妥協なき姿勢
- **すべての機能は動作するテストと共に実装する**
- **問題が発生した場合は無効化ではなく根本原因を特定し修正する**
- **アルゴリズムの理論的正しさを数学的に検証する**
- **性能とメモリ効率を測定し、退行を防ぐ**
- **エッジケースと境界条件を網羅的にテストする**

### コード品質基準
- **実装はアルゴリズムの理論に忠実であること**
- **FFT版と基本版が数学的に等価な結果を返すこと**
- **すべてのパブリックAPIが完全にテストされていること**
- **エラー処理が適切に実装されていること**

テストが失敗した場合は、その原因を突き止めて修正するまで作業を続ける。
一時的な無効化や回避策は技術的負債を生むため避ける。